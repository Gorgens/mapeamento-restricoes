r.in.lidar -o -e --overwrite input=/home/gorgens/Documents/grassdata/INPE/d_universal/NP_T-403.las output=t403_min method=min resolution=1

g.region raster=t403_min@universal

r.neighbors --overwrite input=t403_min@universal output=t403_mdt method=min size=7
r.neighbors --overwrite input=t403_mdt@universal output=t403_mdt_v2 method=median size=11

r.in.lidar -o -e --overwrite input=/home/gorgens/Documents/grassdata/INPE/d_universal/NP_T-403.las output=t403_mds method=percentile pth=95 resolution=1

r.mapcalc "t403_chm = t403_mds@universal - t403_mdt_v2@universal" --overwrite

r.out.ascii --overwrite input=t403_chm@universal output=/home/gorgens/Documents/grassdata/INPE/d_universal/t403_chm precision=2 null_value=-9999

r.mapcalc "t403_topcanopy = if( t403_chm@universal < 35 , null()  , t403_chm@universal)" --overwrite

r.to.vect --overwrite input=t403_topcanopy@universal output=t403_tocanopy_vector type=area

# Verify code
v.clean input=t403_tocanopy_vector out=t403_tocanopy_vclean tool=snap,break,rmdupl thresh=.01
v.dissolve input=t403_tocanopy_vclean@universal output=t403_tocanopy_vdissolve@universal
v.db.addcolumn map=t403_tocanopy_vector@universal columns="area_m DOUBLE PRECISION"
v.to.db map=t403_tocanopy_vector@universal option=area columns=area_m units=meters
